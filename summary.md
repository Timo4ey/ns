
# Notification Service
![Alt text](схема_ns.png)

### Admin
- Админ заводит Services
- Админ заводит Adapters

### Adapters
- стоят внутри и/или на границах сервиса
- экземпляров одного адаптера может быть несколько
- адаптеры разгребают очередь из Broker
- набор адаптеров подписывается на одну очередь в кролике
- когда адаптер принимает event из очереди, он обращается к базе данных и обновляет параметры start_time, 
- после того как задача выполнена adapter добавляет в DB finish_time
- адаптеры взаимодействуют с DB по средству контроллеров
- адаптер сравнивает параметр expire с текущим временем и если задача просрочена не выполняет её
- Адаптер отвечает за реальных статус задачи
- адаптер может быть заблокирован

### Core Service (NS)
- ядро реализует API для взаимодействие с внешними сервисами (http)
- ядро реализует API для взаимодействие с Admin (http)
- ядро на основе полученных данных создаёт оффер в базе данных
    - Нужно реализовать интерфейс Offer
        - Offer.create_one -> создает сущность оффер в базе данных
        - Offer.update_one -> обновляет оффер в базе данных
        - Offer.delete_one -> удаляет оффер в базе данных
- когда NS кладёт задачу в очередь NS создаёт сущность Job в базе данных
- отправляет событие в Broker send.event()
- NS взаимодействуют с DB посредством контроллеров


### DB
- база данных взаимодействует с NS при создании сущности Offer
- админ добавляет адаптеры в базу данных

### Broker (RMQ)
- принимает события из NS


### Client (Outer Services)
- клинты взаимодействую с NS по средствам http через  внешний API
- от сервисов в ядро

### NS-lib
- в библиотеке есть описание ресурсов
- связанна с Adapters и NS
- NS забирает транспорт (http)
- Adapters забирает контроллер




- Отмена джобы
    - NS отправляет в кролик через нотифай информацию об отмене
    - Каждая нода адаптера принявшая информацию об отмене проверяет в себя в памяти (либо в редис) о том есть ли такая задача
    - если задача есть и она не выполнена, то она удаляется из стека выполнения и в базу данных летит запрос на изменение состояния на canceled

Проблема: Не понятно как адаптер поймёт что нода уже отменена
- либо проверяет статус в базе
- либо между адаптерами есть единая база (NOSQL) с отменными джобами и сравнивая id отсеиваются все уже отменённые

## ТЗ:
- я хочу как администратор 
    - задавать ключи сервисам
    - дать чуваку возможность зарегаться
    - могу завести адаптеры
    - должна быть возможность считать какие адаптеры вообще в системе есть
    - при регистрации адаптера нужно будет в params json-схему засовывать, чтобы понимать какие параметры нужно передать, чтобы с этим  адаптером по взаимодействовать
    - я даю разработчику API-key
        - разработчик в конфигурации адаптера прописывает API-key
        - адаптер подключается к кролику и слушает очередь с именем API-key
        - имя очереди должно быть в БД
        - кролик один
        - взаимодействие между ядром и адаптерами через очередь
        - отмена либо через редис либо через fanout
- создать репо
    - должны быть папки:
        - ns-lib
        - core-ns
        - adapters
            - sms-adapter
            - telegram-adapter
            - ...
- сформировать блан выполнения
- определить что такое:
    - оффер
    - адаптер
        - какие параметры имеет
    - что такое job
- что происходит когда админ заводит адаптер
    - какие поля должен заполнить?
-


Есть тип адаптера (Telegram, VK, Avit etc.)
- а есть конкретный адаптер внутри экземпляра адаптера
<br>
Например: я могу email-адаптер настроить на 2 разных *smtp-server

Как создавать адаптеры:
1. Первый вариант. 
    - Администратор приходит в NS (api-key, params(include endpoint(for example smtp)))
    - NS добавляет данные в БД
    - Админ отдаёт api-key в девопс
    - Девопсы поднимают адаптеры(или набор адаптеров) и на вход передают api-key
    - Адаптеры идут в базу данных и считывают по api-key свою строчку с информацией (params)
    - Адаптеры после получения params настраиваются под конкретные сервисы
    - Клиент может выбрать из адаптеров, которые для него создали 

Пример джобы
```json
{
    "offer_id": 1,
    "create_time": "12-29-2023 15:13:44",
    "expire_time": "12-29-2024 15:13:44",
    "adapter_name": "telegram-adapter-1234",
    "params":{
        "api-key": "uXjVNA7EwWk",
        "connection_type": "http",
        "access_data": {
            "access_token": "AAQkAGI2ZjAzZjA2LTI4NzMtNDcyYy1iYTZkLTUzMjdmZmFlZDkwNQAQAIlkigXQ5nVHgtSC3Wq68hs%3D"
        },
        "endpoint": "" 
    },
    
    "job_id": 1,
    "state": "Queued"
    
}
```

Пример params
```json
{
    "params":{
        "api-key": "uXjVNA7EwWk",
        "connection_type": "http",
        "access_data": {
            "access_token": "AAQkAGI2ZjAzZjA2LTI4NzMtNDcyYy1iYTZkLTUzMjdmZmFlZDkwNQAQAIlkigXQ5nVHgtSC3Wq68hs%3D"
        },
        "endpoint": "" 
    },
}
```
___

*Simple Mail Transfer Protocol (SMTP) — простой протокол связи, применяемый с целью пересылки электронных писем с сервера отправителя на сервер получателя.


